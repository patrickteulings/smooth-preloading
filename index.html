<!DOCTYPE html>
<html lang="nl">

<head>

<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">

<title>SMOOTH PRELOADING</title>


<!-- STYLES -->
<style>
    img{
        width:200px;
        float:left;
        margin: 10px 10px 0 0;
    }

    #hero{
        height: 300px;
    }
    #bg{
        height: 380px;
    }
    .bgContainer{
        margin: 10px 10px 0 0;
        width: 200px;
        height: 0px;
        background-size:cover;
        float:left;

    }
</style>




</head>

<body>
    <div><h3>Add a smooth preloading progress bar <button id="start">START</button></h3></div>
    <hr/>
    <div id="progress" style="width:0%; height: 10px; background:#333"></div>
    <div id="hero"></div>
    <hr/>
    <div id="bg">
        <div class="bgContainer" id="BG-01"></div>
        <div class="bgContainer" id="BG-02"></div>
        <div class="bgContainer" id="BG-03"></div>
        <div class="bgContainer" id="BG-04"></div>
    </div>
    <hr/>
    
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://code.createjs.com/preloadjs-0.6.0.min.js"></script>

    
    <script>
        $(document).ready(function(){
            
            var preload; // our createJS image preloader
            var smoothPreloadProgress;


            function SmoothPreloadProgress(){
                var currentWidth = 0;
                var destinationWidth = 0;
                var diffWidth = 0;
                var request;
                var targetWidth = $(window).width();
                var stopped = false; // NEED A BOOLEAN TO FORCE THE CORRECT WIDTH

                function updateProgress(_loaded,_total){
                    currentWidth = parseInt($('#progress').css('width'));
                    destinationWidth = $(window).width() * _loaded;        
                }


                //
                // THE PROGRESS BAR ANIMATION
                //


                function animate(){
                    
                    if(stopped === true) return false;

                    // THE DIFFERENCE BETWEEN THE DESIRED CURRENT WIDTH AND THE ACTUAL WIDTH
                    diffWidth = destinationWidth - currentWidth;
                    
                    // ADD A SMALL AMOUNT OF THE DIFFERENCE TO THE PROGRESS BAR
                    var translateWidth = ((currentWidth + (diffWidth/20)));
                    
                    // SET ACTUAL WIDTH
                    $('#progress').css('width',translateWidth );
                    
                    // RESET CURRENT WIDTH VAR SO WE CAN ADD A SMALL AMOUNT AGAIN
                    currentWidth = parseInt($('#progress').css('width'));
                    
                    
                    if(currentWidth >= targetWidth){
                        stopLoop();
                    }

                    console.log('active: ' + currentWidth  + ' -- ' + $(window).width());

                }


                //
                // ADD REQUEST ANIMATION FRAME FOR SMOOTH ANIMATING
                //


                function addEvents(){
                    window.requestAnimFrame = (function(){
                        return  window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame ||
                        function( callback ){
                            window.setTimeout(callback, 1000 / 60);
                        };
                    })();

                    (function animloop(){
                        animate();
                        request = requestAnimFrame(animloop);
                        
                    })();

                }
                

                //
                // REMOVE ANIMATION FRAME WHEN DONE
                //


                function stopLoop(){
                    setTimeout(function(){            
                        cancelRequestAnimFrame(request);                
                        $('#progress').css('width',targetWidth);
                        stopped = true;
                    }, 1*1000);
                    
                    
                } 


                //
                // REQUEST ANIMATION CANCEL
                //
                

                window.cancelRequestAnimFrame = ( function() {
                    return window.cancelAnimationFrame          ||
                        window.webkitCancelRequestAnimationFrame    ||
                        window.mozCancelRequestAnimationFrame       ||
                        window.oCancelRequestAnimationFrame     ||
                        window.msCancelRequestAnimationFrame        ||
                        clearTimeout

                } )();      
                
                
                //
                // PUBLIC
                //


                return{
                    updateProgress:updateProgress,
                    startProgress:addEvents,
                    stopProgress:stopLoop
                }
            }



            function handleFileComplete(event){
                console.log(event);
                console.log(event.item.id);
                $('#hero').append(event.result);
                $('#'+event.item.id).css('background-image','url(' + event.result.currentSrc + ')')
                $('#'+event.item.id).animate({'height':200},200);
            }


            function handleProgress(event){
                smoothPreloadProgress.updateProgress(preload.progress);
            }


            function handleComplete(event){
                
                smoothPreloadProgress.stopProgress();
                //$('#progress').css('width',(preload.progress * 100) + '%');
            }            

            function loadImage() {
                smoothPreloadProgress = new SmoothPreloadProgress();

                preload = new createjs.LoadQueue();
                preload.addEventListener("fileload", handleFileComplete);
                preload.addEventListener("progress", handleProgress);
                preload.addEventListener("complete", handleComplete);
                
                var manifest = [{src:"contact.jpg", id:"BG-01"},{src:"home.png", id:"BG-02"},{src:"koorenhuis.png", id:"BG-03"},{src:"koorenhuis.jpg", id:"BG-04"}]
                //preload.loadFile(["contact.jpg",'home.png']);
                preload.loadManifest(manifest);
            
                smoothPreloadProgress.startProgress();
            }

            $('#start').on('click',function(){
                loadImage();
            });


        });
    </script>

</body>
</html>
